{% extends "api/base.html" %}

{% block title %}Your Custom Heart Rate Zones{% endblock %}

{% block content %}
    <style>
nav {
            display: none !important; /* Hide the main navigation bar */
        }

        /* Strava-inspired styles for hr_zone_display */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: #f7f7f7;
            color: #333333;
        }

        h1 {
            color: #333333;
            font-size: 28px;
            margin-bottom: 20px;
        }

        h2 { /* Configuration heading */
            color: #4a4a4a;
            font-size: 20px;
            font-weight: 600;
            margin-top: 25px;
            margin-bottom: 10px;
        }

        h3 { /* "Heart Rate Zones:" heading */
            color: #4a4a4a;
            font-size: 18px;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .hr-zones-table {
            width: 100%;
            max-width: 600px;
            border-collapse: collapse;
            margin-top: 15px;
            margin-bottom: 25px;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border-radius: 4px;
            overflow: hidden;
        }

        .hr-zones-table th,
        .hr-zones-table td {
            border: none;
            border-bottom: 1px solid #e5e5e5;
            padding: 12px 15px;
            text-align: left;
            vertical-align: middle;
        }

        .hr-zones-table th {
            background-color: #f9f9f9;
            color: #555;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        .hr-zones-table tr:last-child td {
            border-bottom: none;
        }

        /* Zone-specific row styling */
        .zone-row {
            border-left: 10px solid transparent;
        }
        .zone-1 { border-left-color: #6D6D6D; } /* Zone 1: Grey */
        .zone-2 { border-left-color: #0077CC; } /* Zone 2: Blue */
        .zone-3 { border-left-color: #5E9E00; } /* Zone 3: Green */
        .zone-4 { border-left-color: #FF9900; } /* Zone 4: Orange/Yellow */
        .zone-5 { border-left-color: #E60000; } /* Zone 5: Red */
        .zone-6 { border-left-color: #333333; } /* Zone 6 (if exists) */

        #fetchStravaHrZonesButton {
            background-color: #FC4C02; /* Strava Orange */
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #fetchStravaHrZonesButton:hover {
            background-color: #e04402; /* Darker Strava Orange */
        }

        #fetchStravaHrZonesButton:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* Message styles */
        #fetchStatusMessage { /* Default style for the status div before specific classes are applied */
            padding: 10px 15px;
            margin-top: 15px;
            border-radius: 4px;
            font-size: 14px;
            min-height: 1.5em; /* Prevent layout shift when empty */
        }
        .error-message {
            color: #D8000C;
            background-color: #FFD2D2;
            border: 1px solid #D8000C;
        }
        .info-message {
            color: #00529B;
            background-color: #BDE5F8;
            border: 1px solid #00529B;
        }
        .success-message {
            color: #270; /* Dark Green */
            background-color: #DFF2BF; /* Light Green */
            border: 1px solid #270; /* Dark Green border */
        }

        .container a, p a {
            color: #0077CC;
            text-decoration: none;
            font-weight: 500;
        }
        .container a:hover, p a:hover {
            text-decoration: underline;
            color: #005ea6;
        }

        p.back-link {
            margin-top: 30px;
            font-size: 14px;
        }
        p.back-link a {
            color: #666;
        }
        p.back-link a:hover {
            color: #333;
        }
    </style>

    <div class="container">
        <h1>Your Custom Heart Rate Zones</h1>

        {% if error_message %}
            <p class="error-message">{{ error_message }}</p>
        {% elif custom_zones_config %}
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <h2 style="margin:0;">Configuration: {% if custom_zones_config.config_name %}{{ custom_zones_config.config_name }} - {% endif %}{{ custom_zones_config.get_activity_type_display|default:custom_zones_config.activity_type }}</h2>
                {% if custom_zones_config.activity_type == "DEFAULT" %}
                <button id="addActivityConfigButton" title="Add activity-specific configuration" style="display:inline-flex; align-items:center; justify-content:center; width:22px; height:22px; background-color:#FC4C02; color:white; border:none; border-radius:50%; font-size:14px; font-weight:600; line-height:1; cursor:pointer;">+</button>
                {% endif %}
            </div>

            {% if hr_zones %}
                <form id="hrZoneForm" method="POST">
                    {% csrf_token %}
                    {% if custom_zones_config %}
                    <input type="hidden" id="config_id" name="config_id" value="{{ custom_zones_config.id }}">
                    <input type="hidden" id="activity_type" name="activity_type" value="{{ custom_zones_config.activity_type }}">
                    {% endif %}
                <table class="hr-zones-table">
                    <thead>
                        <tr>
                            <th>Zone Name</th>
                            <th>Min HR (bpm)</th>
                            <th>Max HR (bpm)</th>
                        </tr>
                    </thead>
                    <tbody id="hrZonesTableBody">
                        {% for zone in hr_zones %}
                        <tr class="zone-row zone-{{ forloop.counter }}" data-zone-order="{{ forloop.counter }}">
                            <td>
                                <input type="text" name="zone_name_{{ forloop.counter }}" value="{{ zone.name }}" class="zone-name-input" style="width:120px; padding: 6px; border: 1px solid #ccc; border-radius: 4px;" required>
                                <input type="hidden" name="zone_order_{{ forloop.counter }}" value="{{ forloop.counter }}">
                            </td>
                            <td>
                                <span id="min-hr-display-{{ forloop.counter }}" class="min-hr-display" style="padding: 6px;">
                                    {% if forloop.first %}0{% else %}{{ zone.min_hr }}{% endif %}
                                </span>
                                <input type="hidden" id="zone_min_hr_input_{{ forloop.counter }}" name="zone_min_hr_{{ forloop.counter }}" value="{% if forloop.first %}0{% else %}{{ zone.min_hr }}{% endif %}">
                            </td>
                            <td>
                                <input type="number" name="zone_max_hr_{{ forloop.counter }}" class="zone-max-hr-input" style="width:100px; padding: 6px; border: 1px solid #ccc; border-radius: 4px;"
                                       value="{% if zone.max_hr and zone.max_hr != 0 and zone.max_hr != 999 %}{{ zone.max_hr }}{% endif %}"
                                       placeholder="{% if zone.max_hr == 999 %}e.g. 220{% elif not zone.max_hr or zone.max_hr == 0 %}e.g. 120{% endif %}"
                                       min="1">
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div style="margin-top: 20px; margin-bottom: 15px;">
                    <button type="submit" id="saveHrZonesButton" class="strava-button">Save Changes</button>
                </div>
                </form>
            {% else %}
                <p class="info-message">No heart rate zones are defined for the '{{ custom_zones_config.config_name }}' configuration.</p>
            {% endif %}
        {% else %}
            <p class="info-message">No custom heart rate zone configuration found. You can set one up in your profile settings.</p>
        {% endif %}

        <div style="margin-top: 20px;">
            <button id="fetchStravaHrZonesButton">Fetch/Refresh HR Zones from Strava</button>
            <div id="fetchStatusMessage"></div>
        </div>

        <p class="back-link"><a href="/">Back to Home</a></p>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('hrZoneForm');
    // const saveButton = document.getElementById('saveHrZonesButton'); // Not directly used, event is on form submit
    const statusMessageDiv = document.getElementById('fetchStatusMessage');
    const configIdInput = document.getElementById('config_id');
    const activityTypeInput = document.getElementById('activity_type');
    const tableBody = document.getElementById('hrZonesTableBody');

    if (!form || !tableBody) {
        return;
    }

    const zoneRows = tableBody.querySelectorAll('tr');

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    zoneRows.forEach((row) => {
        const maxHrInput = row.querySelector('.zone-max-hr-input');
        if (maxHrInput) {
            maxHrInput.addEventListener('input', function () {
                const currentZoneOrder = parseInt(row.dataset.zoneOrder);
                const nextZoneOrder = currentZoneOrder + 1;
                const nextZoneRow = tableBody.querySelector(`tr[data-zone-order="${nextZoneOrder}"]`);

                if (nextZoneRow) {
                    const nextMinHrDisplay = nextZoneRow.querySelector('.min-hr-display');
                    const nextMinHrInput = nextZoneRow.querySelector('input[name^="zone_min_hr_"]');
                    let newMinHr = parseInt(this.value);
                    if (isNaN(newMinHr) || newMinHr < 0) newMinHr = 0; // Default to 0 if invalid

                    nextMinHrDisplay.textContent = newMinHr;
                    nextMinHrInput.value = newMinHr;
                }
            });
        }
    });

    form.addEventListener('submit', function (event) {
        event.preventDefault();
        statusMessageDiv.textContent = 'Saving...';
        statusMessageDiv.className = 'info-message';

        const configId = configIdInput ? configIdInput.value : null;
        const activityType = activityTypeInput ? activityTypeInput.value : 'DEFAULT';

        if (!configId) {
            statusMessageDiv.textContent = 'Error: Configuration ID is missing.';
            statusMessageDiv.className = 'error-message';
            return;
        }

        const zonesDefinition = [];
        let overallIsValid = true;
        let previousMaxHr = 0; // Min HR for Zone 1 is 0.

        for (const row of zoneRows) {
            const order = parseInt(row.dataset.zoneOrder);
            const nameInput = row.querySelector('.zone-name-input');
            const maxHrInput = row.querySelector('.zone-max-hr-input');

            const name = nameInput.value.trim();
            const max_hr_string = maxHrInput.value.trim();
            const max_hr = parseInt(max_hr_string);

            let min_hr = (order === 1) ? 0 : previousMaxHr;

            if (!name) {
                statusMessageDiv.textContent = `Error: Zone ${order} name cannot be empty.`;
                overallIsValid = false;
                break;
            }
            if (max_hr_string === '' || isNaN(max_hr) || max_hr <= 0) {
                 statusMessageDiv.textContent = `Error: Zone ${order} Max HR must be a positive number.`;
                 overallIsValid = false;
                 break;
            }
            if (max_hr <= min_hr) {
                statusMessageDiv.textContent = `Error: Zone ${order} Max HR (${max_hr}) must be greater than its Min HR (${min_hr}).`;
                overallIsValid = false;
                break;
            }

            zonesDefinition.push({
                name: name,
                min_hr: min_hr,
                max_hr: max_hr,
                order: order
            });
            previousMaxHr = max_hr;
        }

        if (!overallIsValid) {
            statusMessageDiv.className = 'error-message';
            return;
        }

        const payload = {
            activity_type: activityType,
            zones_definition: zonesDefinition
        };

        fetch(`/api/settings/custom-zones/${configId}/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) {
                 return response.json().then(errData => {
                    let errorMsg = 'Error saving zones.';
                    if (errData) {
                        const messages = [];
                        for (const key in errData) {
                            if (Array.isArray(errData[key])) {
                                errData[key].forEach(msg => {
                                    if (typeof msg === 'string') messages.push(`${key}: ${msg}`);
                                    else if (typeof msg === 'object' && msg.detail) messages.push(`${key}: ${msg.detail}`);
                                    else if (typeof msg === 'object') messages.push(`${key}: ${JSON.stringify(msg)}`);
                                });
                            } else {
                                messages.push(`${key}: ${errData[key]}`);
                            }
                        }
                        if (messages.length > 0) errorMsg = messages.join('; ');
                    }
                    throw new Error(errorMsg);
                });
            }
            return response.json();
        })
        .then(data => {
            statusMessageDiv.textContent = 'Heart rate zones saved successfully!';
            statusMessageDiv.className = 'success-message';
            // Consider refreshing zone values from `data` if backend modifies/cleans them
            // For simplicity, a page refresh after successful save would also show new state.
            // location.reload(); // Uncomment to reload page on success
        })
        .catch(error => {
            statusMessageDiv.textContent = error.message || 'Error saving zones. Please try again.';
            statusMessageDiv.className = 'error-message';
        });
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fetchButton = document.getElementById('fetchStravaHrZonesButton');
    const statusMessageDiv = document.getElementById('fetchStatusMessage');
    const API_FETCH_URL = '/api/fetch-strava-hr-zones/'; // Correct endpoint for FetchStravaHRZonesView
    const csrfToken = "{{ csrf_token }}";

    if (fetchButton) {
        fetchButton.addEventListener('click', function() {
            // Check if a custom config exists (passed from Django template)
            const customConfigId = "{{ custom_zones_config.id|default:'' }}"; // Get config ID, default to empty string if not set

            if (customConfigId) { // If there's a config ID, it means a config exists that might be overwritten
                const userConfirmed = confirm("Fetching new zones from Strava will override your current custom settings and any unsaved changes will also be lost. Are you sure you want to proceed?");
                if (!userConfirmed) {
                    statusMessageDiv.textContent = 'Operation cancelled by user.';
                    statusMessageDiv.className = 'info-message'; // Use existing styles
                    return; // Abort if user cancels
                }
            }

            statusMessageDiv.textContent = 'Fetching HR zones from Strava...';
            statusMessageDiv.className = 'info-message'; // Use existing styles
            fetchButton.disabled = true;

            fetch(API_FETCH_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                // body: JSON.stringify({}), // Add body if your endpoint expects it
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    return response.json().then(err => {
                        throw new Error(err.detail || err.message || 'Failed to fetch HR zones.');
                    });
                }
            })
            .then(data => {
                statusMessageDiv.textContent = data.message || 'HR zones fetched successfully! Reloading page...';
                statusMessageDiv.className = 'success-message';
                // Reload the page to see updated zones
                setTimeout(() => {
                    window.location.reload();
                }, 2000); // Delay for user to read message
            })
            .catch(error => {
                console.error('Error fetching HR zones:', error);
                statusMessageDiv.textContent = 'Error: ' + error.message;
                statusMessageDiv.className = 'error-message'; // Use existing styles
            })
            .finally(() => {
                fetchButton.disabled = false;
            });
        });
    }
});
</script>

<script>
(function() {
  let dropdown;
  function closeDropdown() {
    if (dropdown) { dropdown.remove(); dropdown = null; document.removeEventListener('click', handleDocClick); }
  }
  function handleDocClick(e) {
    if (dropdown && !dropdown.contains(e.target) && e.target.id !== 'addActivityConfigButton') {
      closeDropdown();
    }
  }
  document.addEventListener('DOMContentLoaded', function() {
    const addBtn = document.getElementById('addActivityConfigButton');
    if (!addBtn) return;
    addBtn.addEventListener('click', function(e) {
      e.preventDefault();
      if (dropdown) { closeDropdown(); return; }
      const types = [
        { value: 'DEFAULT', label: 'Default' },
        { value: 'RUN', label: 'Run' },
        { value: 'RIDE', label: 'Ride' }
      ];
      const existing = JSON.parse('{{ existing_activity_types_json|escapejs }}');
      const available = types.filter(t => !existing.includes(t.value));
      if (!available.length) return;
      const rect = addBtn.getBoundingClientRect();
      dropdown = document.createElement('div');
      dropdown.id = 'activityTypeDropdown';
      dropdown.style.position = 'absolute';
      dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
      dropdown.style.left = (rect.left + window.scrollX) + 'px';
      dropdown.style.background = '#fff';
      dropdown.style.border = '1px solid #ccc';
      dropdown.style.borderRadius = '4px';
      dropdown.style.boxShadow = '0 1px 3px rgba(0,0,0,0.2)';
      dropdown.style.fontSize = '14px';
      dropdown.style.minWidth = '100px';
      dropdown.style.zIndex = '1000';
      available.forEach(t => {
        const item = document.createElement('div');
        item.textContent = t.label;
        item.dataset.value = t.value;
        item.style.padding = '6px 8px';
        item.style.cursor = 'pointer';
        item.addEventListener('mouseenter', () => item.style.backgroundColor = '#f5f5f5');
        item.addEventListener('mouseleave', () => item.style.backgroundColor = '#fff');
        item.addEventListener('click', function() {
          // TODO: handle selection
          closeDropdown();
        });
        dropdown.appendChild(item);
      });
      document.body.appendChild(dropdown);
      setTimeout(() => document.addEventListener('click', handleDocClick), 0);
    });
  });
})();
</script>

{% endblock %}
